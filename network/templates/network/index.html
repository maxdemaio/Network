{% extends "network/layout.html" %}

{% block head %}
<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script type="text/javascript">
    // Obtain CSRF Token
    function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    // Does this cookie string begin with the name we want?
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        };


    // Upon submission, the following function will post to the Django backend
    // The JS will fetch the response and update the post's contents.
    function editPost() {
        const csrftoken = getCookie('csrftoken');

        $('.ajaxProgress').show();
        $.ajax({
            type: "POST",
            url: "{% url 'editPost' %}",
            dataType: "json",
            async: true,
            data: { csrfmiddlewaretoken: csrftoken },
            success: function (json) {
                console.log("Success");
            }
        });
    };

    // Obtain post's ID, and display a text area pre-populated with contents to edit
    function example(clicked_id) {
        contentElementID = "content-" + clicked_id;
        contentElement = document.querySelector("#" + contentElementID);
        content = contentElement.innerHTML;

        // Create text area and populate contents
        var textArea = document.createElement("textarea");
        contentElement.appendChild(textArea); 
        console.log(content);
    };
    
</script>
{% endblock %}


{% block body %}
<h1>All Posts</h1>

<div id="new-post-section">

    {% if messages %}
        {% for message in messages %}
        <div class="alert alert-danger" role="alert">{{ message }}</div>
        {% endfor %}
    {% endif %}

    <h2>New Post</h2>
    <form action="/" method="post">
        {% csrf_token %}
        {{ newPostForm }}
        <input class="btn btn-primary" type="submit" value="Submit">
    </form>
    
</div>

<div class="posts-section">
    {% for post in allPosts %}
    <div id="post-{{forloop.counter}}" class="post">
        <p><a href="{% url 'profile' post.user %}" data-url="{% url 'editPost' %}"><strong>{{ post.user }}</strong></a></p>
        {% if currentUserID == post.user_id %}
        <div>
            <a id="{{forloop.counter}}" class="my-link" onClick="javascript:example(this.id)">Edit</a>
        </div>
        {% endif %}

        <div id="content-{{forloop.counter}}" class="post-content">
            {{ post.content }}
        </div>

        <div class="text-muted">
            {{ post.time_posted }}
        </div>

        <div>
            ❤️ <span class="text-muted">{{ post.like_count }}</span>
        </div>
    </div>
    {% endfor %}
</div>

{% endblock %}